{{ define "main" }}
<div class="dashboard-container">
    <header class="dashboard-header">
        <h1>Your Coding Challenge Dashboard</h1>
        <button id="dashboard-sign-out-button" class="sign-out-btn">Sign Out</button>
    </header>
    <div class="dashboard-content">
        <div id="dashboard-user-info" class="user-info-card">
            <h2>User Information</h2>
            <p>Loading user information...</p>
        </div>
        <div class="dashboard-cards">
            <div class="card">
                <h3>Quick Actions</h3>
                <button id="verify-email-btn" class="action-btn">Verify Email</button>
                <button id="update-profile-btn" class="action-btn">Update Profile</button>
            </div>
            <div class="card">
                <h3>Activity Summary</h3>
                <p>Last login: <span id="last-login">Loading...</span></p>
                <p>Account created: <span id="account-created">Loading...</span></p>
            </div>
            <div class="card">
                <h3>Challenge Progress</h3>
                <p>Days Completed: <span id="days-completed">0</span> / 60</p>
                <div class="progress-bar">
                    <div id="progress-fill"></div>
                </div>
            </div>
        </div>
        <div class="card task-list">
            <h3>60 Days of Coding Challenge</h3>
            <ul id="task-list">
                <!-- Tasks will be dynamically added here -->
            </ul>
        </div>
    </div>
</div>

<style>
    .dashboard-container {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1000px;
        margin: 2rem auto;
        padding: 2rem;
        background-color: #f8f9fa;
        border-radius: 12px;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }
    h1, h2, h3 {
        color: #333;
        margin-bottom: 1rem;
    }
    .dashboard-content {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }
    .user-info-card, .card {
        background-color: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    .user-info-card {
        grid-column: 1 / -1;
    }
    .dashboard-cards {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 1rem;
    }
    .sign-out-btn, .action-btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        transition: background-color 0.3s ease;
    }
    .sign-out-btn {
        background-color: #dc3545;
        color: white;
    }
    .sign-out-btn:hover {
        background-color: #c82333;
    }
    .action-btn {
        background-color: #007bff;
        color: white;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }
    .action-btn:hover {
        background-color: #0056b3;
    }
    .task-list {
        grid-column: 1 / -1;
        margin-top: 2rem;
    }
    #task-list {
        list-style-type: none;
        padding: 0;
        max-height: 400px;
        overflow-y: auto;
    }
    #task-list li {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
        padding: 0.5rem;
        background-color: #f8f9fa;
        border-radius: 4px;
    }
    #task-list input[type="checkbox"] {
        margin-right: 1rem;
    }
    .progress-bar {
        width: 100%;
        height: 20px;
        background-color: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
    }
    #progress-fill {
        height: 100%;
        background-color: #28a745;
        transition: width 0.5s ease-in-out;
    }
    @media (max-width: 768px) {
        .dashboard-content, .dashboard-cards {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const dashboardUserInfo = document.getElementById('dashboard-user-info');
    const dashboardSignOutButton = document.getElementById('dashboard-sign-out-button');
    const verifyEmailBtn = document.getElementById('verify-email-btn');
    const updateProfileBtn = document.getElementById('update-profile-btn');
    const taskList = document.getElementById('task-list');
    const daysCompletedSpan = document.getElementById('days-completed');
    const progressFill = document.getElementById('progress-fill');
    const lastLoginSpan = document.getElementById('last-login');
    const accountCreatedSpan = document.getElementById('account-created');

    let currentUser = null;

    function updateDashboardInfo(user) {
      currentUser = user;
      if (user) {
        dashboardUserInfo.innerHTML = `
                <h2>User Information</h2>
                <p><strong>Name:</strong> ${user.displayName || 'Not set'}</p>
                <p><strong>Email:</strong> ${user.email}</p>
                <p><strong>Email Verified:</strong> ${user.emailVerified ? 'Yes' : 'No'}</p>
            `;

        verifyEmailBtn.style.display = user.emailVerified ? 'none' : 'inline-block';

        lastLoginSpan.textContent = new Date(user.metadata.lastSignInTime).toLocaleString();
        accountCreatedSpan.textContent = new Date(user.metadata.creationTime).toLocaleString();

        loadTasks(user.uid);
      } else {
        dashboardUserInfo.innerHTML = '<p>No user information available.</p>';
        verifyEmailBtn.style.display = 'none';
        taskList.innerHTML = '';
        lastLoginSpan.textContent = 'N/A';
        accountCreatedSpan.textContent = 'N/A';
      }
    }

    function loadTasks(userId) {
      const db = firebase.firestore();
      db.collection('users').doc(userId).collection('tasks').get()
        .then((querySnapshot) => {
          if (querySnapshot.empty) {
            initializeTasks(userId);
          } else {
            const tasks = {};
            querySnapshot.forEach((doc) => {
              tasks[doc.id] = doc.data();
            });
            displayTasks(tasks);
          }
        })
        .catch((error) => {
          console.error("Error loading tasks:", error);
        });
    }

    function initializeTasks(userId) {
      const db = firebase.firestore();
      const batch = db.batch();
      const userTasksRef = db.collection('users').doc(userId).collection('tasks');

      for (let i = 1; i <= 60; i++) {
        const taskRef = userTasksRef.doc(`day${i}`);
        batch.set(taskRef, {
          name: `Day ${i}: Complete coding challenge`,
          completed: false
        });
      }

      batch.commit()
        .then(() => {
          console.log("Tasks initialized successfully");
          loadTasks(userId);
        })
        .catch((error) => {
          console.error("Error initializing tasks:", error);
        });
    }

    function displayTasks(tasks) {
      taskList.innerHTML = '';
      let completedCount = 0;
      for (const taskId in tasks) {
        const task = tasks[taskId];
        const li = document.createElement('li');
        li.innerHTML = `
                <input type="checkbox" id="${taskId}" ${task.completed ? 'checked' : ''}>
                <label for="${taskId}">${task.name}</label>
            `;
        li.querySelector('input').addEventListener('change', (e) => {
          updateTaskStatus(currentUser.uid, taskId, e.target.checked);
        });
        taskList.appendChild(li);
        if (task.completed) completedCount++;
      }
      updateProgress(completedCount);
    }

    function updateTaskStatus(userId, taskId, completed) {
      const db = firebase.firestore();
      db.collection('users').doc(userId).collection('tasks').doc(taskId).update({
        completed: completed
      })
        .then(() => {
          console.log("Task status updated successfully");
          loadTasks(userId);  // Reload tasks to update progress
        })
        .catch((error) => {
          console.error("Error updating task status:", error);
        });
    }

    function updateProgress(completedCount) {
      daysCompletedSpan.textContent = completedCount;
      const progressPercentage = (completedCount / 60) * 100;
      progressFill.style.width = `${progressPercentage}%`;
    }

    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        updateDashboardInfo(user);
      } else {
        if (window.location.pathname !== '/login') {
          window.location.href = '/login';
        }
      }
    });

    dashboardSignOutButton.addEventListener('click', function() {
      firebase.auth().signOut().then(function() {
        console.log("User signed out successfully");
        window.location.href = '/login';
      }).catch(function(error) {
        console.error("Sign out error:", error);
      });
    });

    verifyEmailBtn.addEventListener('click', function() {
      const user = firebase.auth().currentUser;
      user.sendEmailVerification().then(function() {
        alert('Verification email sent. Please check your inbox.');
      }).catch(function(error) {
        console.error("Error sending verification email:", error);
        alert('Error sending verification email. Please try again later.');
      });
    });

    updateProfileBtn.addEventListener('click', function() {
      const user = firebase.auth().currentUser;
      const newName = prompt("Enter your new display name:");
      if (newName) {
        user.updateProfile({
          displayName: newName
        }).then(function() {
          alert('Profile updated successfully!');
          updateDashboardInfo(user);
        }).catch(function(error) {
          console.error("Error updating profile:", error);
          alert('Error updating profile. Please try again later.');
        });
      }
    });
  });
</script>
{{ end }}